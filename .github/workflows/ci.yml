name: ğŸ§© CI - Live Library 24/7

on:
  push:
    branches: [ main, master ]
    paths:
      - "backend/**"
      - "controller/**"
      - "data/**"
      - "requirements.txt"
      - ".github/workflows/**"
  pull_request:
    branches: [ main, master ]
    paths:
      - "backend/**"
      - "controller/**"
      - "data/**"
      - "requirements.txt"
      - ".github/workflows/**"

jobs:
  build-test:
    name: âš™ï¸ Build & Test Backend
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: Sonne1!#
          MYSQL_DATABASE: live_library_manage_system
        ports:
          - 3306:3306
        options: 
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff

      - name: â³ Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 --silent; do
            echo "Waiting for MySQL to start..."
            sleep 3
          done

      - name: ğŸ—„ï¸ Import Database Schema
        run: |
          mysql -h 127.0.0.1 -u root -pSonne1!# < database/Live_library_manage_system.sql
          mysql -h 127.0.0.1 -u root -pSonne1!# < database/insertion.sql
          mysql -h 127.0.0.1 -u root -pSonne1!# < database/CRUD_experts.sql
          mysql -h 127.0.0.1 -u root -pSonne1!# < database/CRUD_courses.sql

      - name: ğŸ§¹ Lint code with flake8
        run: |
          pip install flake8
          flake8 backend --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: ğŸ§ª Test FastAPI imports
        run: |
          python -m compileall backend
      
      - name: Run Ruff auto-fix
        run: |
            ruff check . --fix
            ruff format .
            
      - name: ğŸ’» Check Streamlit scripts
        run: |
          python -m compileall frontend

  # build-frontend:
  #   name: ğŸŒ Build Next.js Frontend (optional)
  #   runs-on: ubuntu-latest
  #   if: "contains(github.event.head_commit.message, '[frontend]') || contains(github.ref, 'frontend')"
  #   defaults:
  #     run:
  #       working-directory: frontend

  #   steps:
  #     - name: ğŸ›ï¸ Checkout repository
  #       uses: actions/checkout@v4

  #     - name: âš›ï¸ Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'

  #     - name: ğŸ“¦ Install dependencies
  #       run: npm ci

  #     - name: ğŸ—ï¸ Build Next.js app
  #       run: npm run build

  #     - name: âœ… Run Lint check
  #       run: npm run lint
  build-and-push:
      runs-on: ubuntu-latest
      needs: [build-test]
      steps:
        - name: Check out repository
          uses: actions/checkout@v4

        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build and push Docker image
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: ${{ secrets.DOCKER_USERNAME }}/sentiment-analysis-app:latest
